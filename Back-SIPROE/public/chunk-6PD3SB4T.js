import{a as _t}from"./chunk-NDS56A3W.js";import"./chunk-YFOZOXJD.js";import{a as et,b as ot,c as it}from"./chunk-LOSPYLTI.js";import{C as Bt,E as Rt,a as vt,b as yt,c as bt,g as St,h as xt,i as Ct,j as Mt,k as wt,l as It,m as Et,n as Pt,o as Dt,p as Tt,q as Ot,r as kt,s as Ht,t as At,y as zt}from"./chunk-7LJP3I4N.js";import{b as rt,g as nt,h as at,m as ct,p as mt,q as dt,r as pt,s as ut,t as ht,u as ft,v as gt,w as Lt}from"./chunk-R6TSHYG5.js";import"./chunk-7S6IQLL5.js";import{X as st,Y as lt}from"./chunk-ZQU5I34W.js";import{i as Y,j as Z,m as tt,r as M,s as $,t as A}from"./chunk-I47XCJ5Y.js";import{E as x,Fb as m,Ob as n,Pb as a,Qb as E,Rb as N,Sb as U,Ub as H,Yb as P,Zb as C,a as w,aa as W,b as I,bb as s,d as $t,fa as q,gb as k,ic as c,jc as D,kc as j,mc as K,nc as Q,oa as T,oc as X,pa as O,pb as J,q as S,ub as f}from"./chunk-OUNE2IBW.js";var v=$t(Lt());var z=class i{constructor(e){this.http=e}apiUrl="http://localhost:4000/api/";canvasId="sorteo-canvas";getDataProyectos(e,t,o){let r=new M({Authorization:`Bearer ${o}`}),p=new $().set("ut",e).set("distrito",t);return this.http.get(this.apiUrl+"sorteo/getSorteos",{headers:r,params:p}).pipe(x(d=>S(()=>d)))}mostrarAnimacion(e=10){let t=document.getElementById(this.canvasId);t&&t.remove();let o=document.createElement("canvas");o.id=this.canvasId,o.width=500,o.height=400,o.style.position="fixed",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.zIndex="1000",o.style.backdropFilter="blur(5px)",document.body.appendChild(o);let r=o.getContext("2d");if(!r)return;class p{constructor(l){this.numero=l;this.x=Math.random()*(o.width-40)+20,this.y=Math.random()*(o.height-40)+20,this.vx=(Math.random()*2-1)*2,this.vy=(Math.random()*2-1)*2,this.color=`hsl(${Math.random()*360}, 70%, 60%)`}x;y;vx;vy;radio=20;color;activa=!0;mover(){this.activa&&(this.x+=this.vx,this.y+=this.vy,(this.x+this.radio>o.width||this.x-this.radio<0)&&(this.vx*=-1),(this.y+this.radio>o.height||this.y-this.radio<0)&&(this.vy*=-1))}dibujar(l){this.activa&&(l.beginPath(),l.arc(this.x,this.y,this.radio,0,Math.PI*2),l.fillStyle=this.color,l.fill(),l.closePath(),l.fillStyle="black",l.font="15px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText(this.numero.toString(),this.x,this.y))}}let d=[];for(let u=1;u<=e;u++)d.push(new p(u));function Ft(){for(let u=0;u<d.length;u++){let l=d[u];if(l.activa)for(let R=u+1;R<d.length;R++){let h=d[R];if(!h.activa)continue;let V=h.x-l.x,F=h.y-l.y,Ut=Math.sqrt(V*V+F*F),jt=l.radio+h.radio;if(Ut<jt){let G=Math.atan2(F,V),g=Math.sin(G),_=Math.cos(G),y={x:l.vx*_+l.vy*g,y:l.vy*_-l.vx*g},b={x:h.vx*_+h.vy*g,y:h.vy*_-h.vx*g};[y.x,b.x]=[b.x,y.x],l.vx=y.x*_-y.y*g,l.vy=y.y*_+y.x*g,h.vx=b.x*_-b.y*g,h.vy=b.y*_+b.x*g}}}}function L(){r&&(r.clearRect(0,0,o.width,o.height),Ft(),d.forEach(u=>{u.mover(),u.dibujar(r)}),requestAnimationFrame(L))}L();let B=0,Nt=setInterval(()=>{B<d.length?(d[B].activa=!1,B++):(clearInterval(Nt),this.ocultarAnimacion())},1e3)}ocultarAnimacion(){let e=document.getElementById(this.canvasId);e&&e.remove()}insertaSorteo(e){let t=new M({Authorization:`Bearer ${e}`});return this.http.post(this.apiUrl+"sorteo/insertaSorteo",{},{headers:t}).pipe(x(o=>S(()=>o)))}actualizaProyecto(e,t){let o=new M({Authorization:`Bearer ${e}`});return this.http.patch(this.apiUrl+"sorteo/actualizaProyecto",t,{headers:o}).pipe(x(r=>S(()=>r)))}deleteSorteo(e,t){let o=new M({Authorization:`Bearer ${e}`}),r=new $().set("id",t);return this.http.delete(this.apiUrl+"sorteo/deleteSorteo",{params:r,headers:o}).pipe(x(p=>S(()=>p)))}actualizaProyectoTo(e,t){let o=new M({Authorization:`Bearer ${e}`});return this.http.patch(this.apiUrl+"sorteo/actualizaToDelete",t,{headers:o}).pipe(x(r=>S(()=>r)))}static \u0275fac=function(t){return new(t||i)(q(A))};static \u0275prov=W({token:i,factory:i.\u0275fac,providedIn:"root"})};function Jt(i,e){if(i&1&&(n(0,"mat-option",11),c(1),a()),i&2){let t=e.$implicit;m("value",t),s(),D(t.ut)}}function Kt(i,e){i&1&&(n(0,"th",30)(1,"b"),c(2,"Folio de Registro"),a()())}function Qt(i,e){if(i&1&&(n(0,"td",31),c(1),a()),i&2){let t=e.$implicit;s(),j(" ",t.folio," ")}}function Xt(i,e){i&1&&(n(0,"th",30)(1,"b"),c(2,"N\xFAmero Aleatorio"),a()())}function Yt(i,e){if(i&1&&(n(0,"td",31),c(1),a()),i&2){let t=e.$implicit;s(),j(" ",t.numero," ")}}function Zt(i,e){i&1&&(N(0,32),f(1,Xt,3,0,"th",22)(2,Yt,2,1,"td",23),U())}function te(i,e){i&1&&E(0,"tr",33)}function ee(i,e){i&1&&E(0,"tr",34)}function oe(i,e){if(i&1){let t=H();n(0,"mat-grid-tile",13)(1,"button",35),P("click",function(){T(t);let r=C(2);return O(r.iniciarSorteo())}),c(2,"Iniciar el Sorteo"),a()()}i&2&&m("colspan",1)("rowspan",1)}function ie(i,e){i&1&&(n(0,"span"),c(1,"Aceptar el Sorteo"),a())}function re(i,e){if(i&1){let t=H();n(0,"mat-grid-tile",13)(1,"button",36),P("click",function(){T(t);let r=C(2);return O(r.aceptarSorteo())}),f(2,ie,2,0,"span",9),a()()}if(i&2){let t=C(2);m("colspan",1)("rowspan",1),s(),m("disabled",t.sorteadosData),s(),m("ngIf",t.sorteoIniciado)}}function ne(i,e){if(i&1){let t=H();n(0,"button",37),P("click",function(){T(t);let r=C(2);return O(r.deshacerSorteo())}),c(1,"Deshacer el Sorteo"),a()}}function ae(i,e){if(i&1&&(n(0,"div")(1,"mat-card-title",2),c(2,"Inventario de proyectos de la Unidad Territorial"),a(),n(3,"mat-grid-list",12)(4,"mat-grid-tile",13)(5,"mat-card",14)(6,"mat-card-content",15)(7,"mat-icon",16),c(8,"inventory"),a(),n(9,"label"),c(10,"Poyectos aprobados "),a(),n(11,"label"),c(12),a()()()(),n(13,"mat-grid-tile",13)(14,"mat-card",14)(15,"mat-card-content",15)(16,"mat-icon",17),c(17,"inventory"),a(),n(18,"label"),c(19," Proyectos sorteados "),a(),n(20,"label"),c(21),a()()()(),n(22,"mat-grid-tile",13)(23,"mat-card",14)(24,"mat-card-content",15)(25,"mat-icon",18),c(26,"inventory"),a(),n(27,"label"),c(28,"Poyectos por sortear"),a(),n(29,"label"),c(30),a()()()()(),n(31,"mat-card-title",2),c(32,"Proyectos Sorteados de la Unidad Territorial"),a(),n(33,"div",19)(34,"table",20),N(35,21),f(36,Kt,3,0,"th",22)(37,Qt,2,1,"td",23),U(),f(38,Zt,3,0,"ng-container",24)(39,te,1,0,"tr",25)(40,ee,1,0,"tr",26),a()(),n(41,"mat-grid-list",27),f(42,oe,3,2,"mat-grid-tile",28)(43,re,3,4,"mat-grid-tile",28),n(44,"mat-grid-tile",13),f(45,ne,2,0,"button",29),a()()()),i&2){let t=C();s(4),m("colspan",1)("rowspan",1),s(8),D(t.aprobados),s(),m("colspan",1)("rowspan",1),s(8),D(t.sorteados),s(),m("colspan",1)("rowspan",1),s(8),D(t.sortear),s(4),m("dataSource",t.proyectos),s(4),m("ngIf",t.sorteoIniciado),s(),m("matHeaderRowDef",t.columnasVisibles),s(),m("matRowDefColumns",t.columnasVisibles),s(2),m("ngIf",!t.sorteoIniciado),s(),m("ngIf",t.sorteoIniciado),s(),m("colspan",1)("rowspan",1),s(),m("ngIf",t.sorteoIniciado)}}function se(i,e){i&1&&(n(0,"div",38),E(1,"canvas",39),a())}var Vt=class i{constructor(e,t,o){this.http=e;this.servicea=t;this.service=o}selectedValues="";sorteoIniciado=!1;mostrarDiv=!1;cambiaSorteo=!1;idDistrital=sessionStorage.getItem("dir")||"0";tokenSesion=sessionStorage.getItem("key")||"0";selectedUnidad=null;unidades=[];proyectos=[];clave_ut="";aprobados;sorteados;sortear;animandoSorteo;sorteadosData;ngOnInit(){this.servicea.catUnidad(parseInt(this.idDistrital),this.tokenSesion).subscribe({next:e=>{this.unidades=e.catUnidad},error:e=>{console.error("Error al cargar unidades",e),e.error.code===160&&this.servicea.cerrarSesionByToken()}})}onDistritoChange(e){this.mostrarDiv=!0,this.clave_ut=e.clave_ut,this.getDataProyectos(this.clave_ut,parseInt(this.idDistrital),this.tokenSesion)}getDataProyectos(e,t,o){this.service.getDataProyectos(e,t,o).subscribe({next:r=>{this.proyectos=r.registrosProyectos,this.aprobados=this.proyectos[0].aprobados,this.sorteados=this.proyectos[0].sorteados,this.sortear=this.proyectos[0].sortear,this.sorteados===0?this.sorteadosData=!1:this.sorteadosData=!0,this.proyectos.some(d=>d.numero_aleatorio&&d.numero_aleatorio!=="")?(this.sorteoIniciado=!0,this.columnasVisibles=["position","numero"],this.proyectos=this.proyectos.map(d=>I(w({},d),{numero:d.numero_aleatorio}))):(this.sorteoIniciado=!1,this.columnasVisibles=["position"])},error:r=>{console.error("Error al cargar proyectos",r),r.error.code===160&&this.servicea.cerrarSesionByToken()}})}columnasVisibles=["position"];iniciarSorteo(){this.cambiaSorteo=!1,this.service.mostrarAnimacion(this.proyectos.length),setTimeout(()=>{this.asignarNumerosAleatorios(),this.sorteoIniciado=!0,this.columnasVisibles=["position","numero"],this.service.ocultarAnimacion()},5e3)}asignarNumerosAleatorios(){let e=new Set;this.cambiaSorteo||this.proyectos.forEach(t=>{let o=parseInt(t.numero_aleatorio);isNaN(o)||e.add(o)}),this.proyectos=this.proyectos.map(t=>{let o;if(!this.cambiaSorteo&&t.numero_aleatorio&&t.numero_aleatorio!=="")return I(w({},t),{numero:t.numero_aleatorio});do o=Math.floor(Math.random()*this.aprobados)+1;while(e.has(o));return e.add(o),I(w({},t),{numero:o.toString()})})}deshacerSorteo(){v.default.fire({title:"\xBFEst\xE1 seguro de deshacer este Sorteo?",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Aceptar",cancelButtonText:"Cancelar"}).then(e=>{if(e.isConfirmed){this.sorteoIniciado=!1,this.columnasVisibles=["position"];let t={sorteo:this.proyectos[0].sorteo};this.service.actualizaProyectoTo(this.tokenSesion,t).subscribe({next:o=>{this.service.deleteSorteo(this.tokenSesion,this.proyectos[0].sorteo).subscribe({next:r=>{v.default.fire({title:"Sorteo deshecho con \xE9xito!",icon:"success",draggable:!1}),this.getDataProyectos(this.clave_ut,parseInt(this.idDistrital),this.tokenSesion)},error:r=>{console.error("Error al actualizar datos del sorteo sorteo",r)}})},error:o=>{console.error("Error al actualizar datos del sorteo sorteo",o),o.error.code===160&&this.servicea.cerrarSesionByToken(),this.cambiaSorteo=!0,v.default.fire("Error","No se pudo deshacer el sorteo.","error")}}),this.proyectos=this.proyectos.map(o=>I(w({},o),{numero:""}))}})}cambiarOrden(){this.asignarNumerosAleatorios()}aceptarSorteo(){this.service.insertaSorteo(this.tokenSesion).subscribe({next:e=>{v.default.fire({title:"Sorteo aplicado con \xE9xito!",icon:"success",draggable:!0});let t=e.id;this.guardaProyectosConSorteo(t)},error:e=>{console.error("Error al crear sorteo",e),e.error.code===160&&this.servicea.cerrarSesionByToken(),v.default.fire("Error","No se pudo crear el sorteo.","error")}})}guardaProyectosConSorteo(e){this.proyectos.forEach(t=>{let o={folio:t.folio,numero_aleatorio:t.numero,sorteo:e};this.service.actualizaProyecto(this.tokenSesion,o).subscribe({next:r=>{this.getDataProyectos(this.clave_ut,parseInt(this.idDistrital),this.tokenSesion)},error:r=>{console.error("Error al guardar proyecto",o,r),r.error.code===160&&this.servicea.cerrarSesionByToken()}})}),v.default.fire("Exito","Sorteo y proyectos guardados correctamente.","success"),this.columnasVisibles=["position"],this.sorteoIniciado=!1}static \u0275fac=function(t){return new(t||i)(k(A),k(_t),k(z))};static \u0275cmp=J({type:i,selectors:[["app-sorteo"]],decls:16,vars:4,consts:[["appearance","outlined",1,"sorteo-card"],[1,"header-content"],[1,"label-header"],[1,"form-section"],[1,"form-label"],["appearance","outline",1,"full-width"],["disableRipple","",3,"selectionChange","valueChange","value"],[3,"value",4,"ngFor","ngForOf"],[1,"card-content"],[4,"ngIf"],["class","overlay",4,"ngIf"],[3,"value"],["cols","3","rowHeight","100px"],[3,"colspan","rowspan"],["appearance","outlined",1,"inventario-card"],[1,"inventario-content"],[1,"iconAprove"],[1,"iconSort"],[1,"iconSorte"],[1,"mat-elevation-z8"],["mat-table","",1,"custom-table",3,"dataSource"],["matColumnDef","position"],["mat-header-cell","","class","center-header",4,"matHeaderCellDef"],["mat-cell","","class","center-cell",4,"matCellDef"],["matColumnDef","numero",4,"ngIf"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["cols","2","rowHeight","100px"],[3,"colspan","rowspan",4,"ngIf"],["mat-fab","","extended","","color","warn",3,"click",4,"ngIf"],["mat-header-cell","",1,"center-header"],["mat-cell","",1,"center-cell"],["matColumnDef","numero"],["mat-header-row",""],["mat-row",""],["mat-fab","","extended","","color","primary",3,"click"],["mat-fab","","extended","","color","accent",3,"click","disabled"],["mat-fab","","extended","","color","warn",3,"click"],[1,"overlay"],["id","canvas","width","400","height","300"]],template:function(t,o){t&1&&(n(0,"mat-card",0)(1,"mat-card-header",1)(2,"mat-card-title",2),c(3,"Nuevo Sorteo"),a(),n(4,"div",3)(5,"label",4),c(6,"Seleccione una Unidad Territorial"),a(),n(7,"mat-form-field",5)(8,"mat-label"),c(9,"Seleccione unidad territorial"),a(),n(10,"mat-select",6),P("selectionChange",function(p){return o.onDistritoChange(p.value)}),X("valueChange",function(p){return Q(o.selectedUnidad,p)||(o.selectedUnidad=p),p}),f(11,Jt,2,2,"mat-option",7),a()()()(),n(12,"mat-card-content",8),f(13,ae,46,18,"div",9),a()(),f(14,se,2,0,"div",10),E(15,"app-footer")),t&2&&(s(10),K("value",o.selectedUnidad),s(),m("ngForOf",o.unidades),s(2),m("ngIf",o.mostrarDiv),s(),m("ngIf",o.animandoSorteo))},dependencies:[gt,pt,ht,ft,ut,Bt,ct,nt,rt,at,At,Mt,It,Tt,Et,wt,Ot,Pt,Dt,kt,Ht,Ct,xt,St,st,dt,mt,vt,yt,bt,zt,Rt,tt,Y,Z,it,ot,et,lt],styles:[".sorteo-card[_ngcontent-%COMP%]{max-width:800px;margin:32px auto;padding:16px}.header-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.label-header[_ngcontent-%COMP%]{font-size:18px;font-weight:600;padding-top:30px;padding-bottom:30px}.form-section[_ngcontent-%COMP%]{width:60%}.form-label[_ngcontent-%COMP%]{font-size:14px;margin-bottom:4px;display:block}.full-width[_ngcontent-%COMP%]{width:100%}.card-content[_ngcontent-%COMP%]{margin-top:24px;display:flex;flex-direction:column;gap:16px;align-items:center;padding-bottom:0!important}mat-form-field[_ngcontent-%COMP%]{margin-right:16px}.buttonSorteo[_ngcontent-%COMP%]{color:#fafafa!important;border-radius:none;background-color:#6745e0!important}.buttonSorteo[_ngcontent-%COMP%]:hover{background-color:#7072dd!important;color:#fafafa!important}.buttonOrden[_ngcontent-%COMP%]{color:#fafafa!important;background-color:#ad6f1e!important}.buttonOrden[_ngcontent-%COMP%]:hover{background-color:#be863b!important;color:#fafafa!important}.buttonSorteoD[_ngcontent-%COMP%]{color:#fafafa!important;background-color:#af2525!important}.buttonSorteoD[_ngcontent-%COMP%]:hover{background-color:#cc4c4c!important;color:#fafafa!important}.overlay[_ngcontent-%COMP%]{position:fixed;padding-left:8%;top:0;left:10px;width:100%;height:100%;background:#fffc;display:flex;justify-content:center;align-items:center;z-index:9999}.inventario-card[_ngcontent-%COMP%]{height:100%}.inventario-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-size:10px;font-weight:700;gap:8px}.iconAprove[_ngcontent-%COMP%]{color:#33c233;font-size:25px}.iconSort[_ngcontent-%COMP%]{color:#53caca;font-size:25px}.iconSorte[_ngcontent-%COMP%]{color:#ad53c9;font-size:25px}.custom-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .custom-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{text-align:center;vertical-align:middle}.center-header[_ngcontent-%COMP%]{font-weight:700;text-align:center}.center-cell[_ngcontent-%COMP%]{text-align:center}"]})};export{Vt as SorteoComponent};
