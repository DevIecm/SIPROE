import{a as _t}from"./chunk-RGYOZ7J6.js";import"./chunk-5HCVWL7T.js";import{a as et,b as ot,c as it}from"./chunk-X6LWYDUR.js";import{A as Bt,E as Rt,G as Ft,a as vt,b as xt,c as yt,g as St,h as bt,i as Ct,j as Mt,k as wt,l as It,m as Pt,n as Et,o as Ot,p as Dt,q as Tt,r as kt,s as Ht,t as At}from"./chunk-D67CAQIW.js";import{b as rt,g as nt,h as at,m as ct,p as mt,q as dt,r as pt,s as ft,t as ut,u as ht,v as gt,w as Lt}from"./chunk-6CAKIS4N.js";import"./chunk-OVN554LP.js";import{X as st,Y as lt}from"./chunk-QD22SGC6.js";import{i as X,j as Y,m as Z,r as H,s as tt,t as A}from"./chunk-RSPXIDQL.js";import{E,Fb as m,Ob as r,Pb as n,Qb as b,Rb as U,Sb as N,Ub as k,Yb as C,Zb as y,a as w,aa as G,b as I,bb as s,d as $t,fa as W,gb as T,ic as c,jc as M,kc as j,mc as J,nc as K,oa as O,oc as Q,pa as D,pb as q,q as P,ub as u}from"./chunk-MQ5UGFIA.js";var S=$t(Lt());var B=class i{constructor(e){this.http=e}apiUrl="http://localhost:4000/api/";canvasId="sorteo-canvas";getDataProyectos(e,t,o){let a=new H({Authorization:`Bearer ${o}`}),h=new tt().set("ut",e).set("distrito",t);return this.http.get(this.apiUrl+"sorteo/getSorteos",{headers:a,params:h}).pipe(E(p=>P(()=>p)))}mostrarAnimacion(e=10){let t=document.getElementById(this.canvasId);t&&t.remove();let o=document.createElement("canvas");o.id=this.canvasId,o.width=500,o.height=400,o.style.position="fixed",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.zIndex="1000",o.style.backdropFilter="blur(5px)",document.body.appendChild(o);let a=o.getContext("2d");if(!a)return;class h{constructor(l){this.numero=l;this.x=Math.random()*(o.width-40)+20,this.y=Math.random()*(o.height-40)+20,this.vx=(Math.random()*2-1)*2,this.vy=(Math.random()*2-1)*2,this.color=`hsl(${Math.random()*360}, 70%, 60%)`}x;y;vx;vy;radio=20;color;activa=!0;mover(){this.activa&&(this.x+=this.vx,this.y+=this.vy,(this.x+this.radio>o.width||this.x-this.radio<0)&&(this.vx*=-1),(this.y+this.radio>o.height||this.y-this.radio<0)&&(this.vy*=-1))}dibujar(l){this.activa&&(l.beginPath(),l.arc(this.x,this.y,this.radio,0,Math.PI*2),l.fillStyle=this.color,l.fill(),l.closePath(),l.fillStyle="black",l.font="15px Arial",l.textAlign="center",l.textBaseline="middle",l.fillText(this.numero.toString(),this.x,this.y))}}let p=[];for(let d=1;d<=e;d++)p.push(new h(d));function zt(){for(let d=0;d<p.length;d++){let l=p[d];if(l.activa)for(let F=d+1;F<p.length;F++){let f=p[F];if(!f.activa)continue;let V=f.x-l.x,z=f.y-l.y,Nt=Math.sqrt(V*V+z*z),jt=l.radio+f.radio;if(Nt<jt){let L=Math.atan2(z,V),g=Math.sin(L),_=Math.cos(L),v={x:l.vx*_+l.vy*g,y:l.vy*_-l.vx*g},x={x:f.vx*_+f.vy*g,y:f.vy*_-f.vx*g};[v.x,x.x]=[x.x,v.x],l.vx=v.x*_-v.y*g,l.vy=v.y*_+v.x*g,f.vx=x.x*_-x.y*g,f.vy=x.y*_+x.x*g}}}}function $(){a&&(a.clearRect(0,0,o.width,o.height),zt(),p.forEach(d=>{d.mover(),d.dibujar(a)}),requestAnimationFrame($))}$();let R=0,Ut=setInterval(()=>{R<p.length?(p[R].activa=!1,R++):(clearInterval(Ut),this.ocultarAnimacion())},1e3)}ocultarAnimacion(){let e=document.getElementById(this.canvasId);e&&e.remove()}insertaSorteo(e){let t=new H({Authorization:`Bearer ${e}`});return this.http.post(this.apiUrl+"sorteo/insertaSorteo",{},{headers:t}).pipe(E(o=>P(()=>o)))}actualizaProyecto(e,t){let o=new H({Authorization:`Bearer ${e}`});return this.http.patch(this.apiUrl+"sorteo/actualizaProyecto",t,{headers:o}).pipe(E(a=>P(()=>a)))}static \u0275fac=function(t){return new(t||i)(W(A))};static \u0275prov=G({token:i,factory:i.\u0275fac,providedIn:"root"})};function Jt(i,e){if(i&1&&(r(0,"mat-option",11),c(1),n()),i&2){let t=e.$implicit;m("value",t),s(),M(t.ut)}}function Kt(i,e){i&1&&(r(0,"th",30)(1,"b"),c(2,"Folio de Registro"),n()())}function Qt(i,e){if(i&1&&(r(0,"td",31),c(1),n()),i&2){let t=e.$implicit;s(),j(" ",t.folio," ")}}function Xt(i,e){i&1&&(r(0,"th",30)(1,"b"),c(2,"N\xFAmero Aleatorio"),n()())}function Yt(i,e){if(i&1&&(r(0,"td",31),c(1),n()),i&2){let t=e.$implicit;s(),j(" ",t.numero," ")}}function Zt(i,e){i&1&&(U(0,32),u(1,Xt,3,0,"th",22)(2,Yt,2,1,"td",23),N())}function te(i,e){i&1&&b(0,"tr",33)}function ee(i,e){i&1&&b(0,"tr",34)}function oe(i,e){if(i&1){let t=k();r(0,"mat-grid-tile",13)(1,"button",35),C("click",function(){O(t);let a=y(2);return D(a.iniciarSorteo())}),c(2,"Iniciar el Sorteo"),n()()}i&2&&m("colspan",1)("rowspan",1)}function ie(i,e){i&1&&(r(0,"span"),c(1,"Aceptar el Sorteo"),n())}function re(i,e){if(i&1){let t=k();r(0,"mat-grid-tile",13)(1,"button",36),C("click",function(){O(t);let a=y(2);return D(a.aceptarSorteo())}),u(2,ie,2,0,"span",9),n()()}if(i&2){let t=y(2);m("colspan",1)("rowspan",1),s(2),m("ngIf",t.sorteoIniciado)}}function ne(i,e){if(i&1){let t=k();r(0,"button",37),C("click",function(){O(t);let a=y(2);return D(a.deshacerSorteo())}),c(1,"Deshacer el Sorteo"),n()}}function ae(i,e){if(i&1&&(r(0,"div")(1,"mat-card-title",2),c(2,"Inventario de proyectos de la Unidad Territorial"),n(),r(3,"mat-grid-list",12)(4,"mat-grid-tile",13)(5,"mat-card",14)(6,"mat-card-content",15)(7,"mat-icon",16),c(8,"inventory"),n(),r(9,"label"),c(10,"Poyectos aprobados "),n(),r(11,"label"),c(12),n()()()(),r(13,"mat-grid-tile",13)(14,"mat-card",14)(15,"mat-card-content",15)(16,"mat-icon",17),c(17,"inventory"),n(),r(18,"label"),c(19," Proyectos sorteados "),n(),r(20,"label"),c(21),n()()()(),r(22,"mat-grid-tile",13)(23,"mat-card",14)(24,"mat-card-content",15)(25,"mat-icon",18),c(26,"inventory"),n(),r(27,"label"),c(28,"Poyectos por sortear"),n(),r(29,"label"),c(30),n()()()()(),r(31,"mat-card-title",2),c(32,"Proyectos Sorteados de la Unidad Territorial"),n(),r(33,"div",19)(34,"table",20),U(35,21),u(36,Kt,3,0,"th",22)(37,Qt,2,1,"td",23),N(),u(38,Zt,3,0,"ng-container",24)(39,te,1,0,"tr",25)(40,ee,1,0,"tr",26),n()(),r(41,"mat-grid-list",27),u(42,oe,3,2,"mat-grid-tile",28)(43,re,3,3,"mat-grid-tile",28),r(44,"mat-grid-tile",13),u(45,ne,2,0,"button",29),n()()()),i&2){let t=y();s(4),m("colspan",1)("rowspan",1),s(8),M(t.aprobados),s(),m("colspan",1)("rowspan",1),s(8),M(t.sorteados),s(),m("colspan",1)("rowspan",1),s(8),M(t.sortear),s(4),m("dataSource",t.proyectos),s(4),m("ngIf",t.sorteoIniciado),s(),m("matHeaderRowDef",t.columnasVisibles),s(),m("matRowDefColumns",t.columnasVisibles),s(2),m("ngIf",!t.sorteoIniciado),s(),m("ngIf",t.sorteoIniciado),s(),m("colspan",1)("rowspan",1),s(),m("ngIf",t.sorteoIniciado)}}function se(i,e){i&1&&(r(0,"div",38),b(1,"canvas",39),n())}var Vt=class i{constructor(e,t,o){this.http=e;this.servicea=t;this.service=o}selectedValues="";sorteoIniciado=!1;mostrarDiv=!1;cambiaSorteo=!1;idDistrital=sessionStorage.getItem("dir")||"0";tokenSesion=sessionStorage.getItem("key")||"0";selectedUnidad=null;unidades=[];proyectos=[];clave_ut="";aprobados;sorteados;sortear;animandoSorteo;ngOnInit(){this.servicea.catUnidad(parseInt(this.idDistrital),this.tokenSesion).subscribe({next:e=>{this.unidades=e.catUnidad},error:e=>{console.error("Error al cargar unidades",e),e.error.code===160&&this.servicea.cerrarSesionByToken()}})}onDistritoChange(e){this.mostrarDiv=!0,this.clave_ut=e.clave_ut,this.getDataProyectos(this.clave_ut,parseInt(this.idDistrital),this.tokenSesion)}getDataProyectos(e,t,o){this.service.getDataProyectos(e,t,o).subscribe({next:a=>{this.proyectos=a.registrosProyectos,console.log("data",this.proyectos),this.aprobados=this.proyectos[0].aprobados,this.sorteados=this.proyectos[0].sorteados,this.sortear=this.proyectos[0].sortear},error:a=>{console.error("Error al cargar proyectos",a),a.error.code===160&&this.servicea.cerrarSesionByToken()}})}columnasVisibles=["position"];iniciarSorteo(){this.cambiaSorteo=!1,this.service.mostrarAnimacion(this.proyectos.length),setTimeout(()=>{this.asignarNumerosAleatorios(),this.sorteoIniciado=!0,this.columnasVisibles=["position","numero"],this.service.ocultarAnimacion()},5e3)}asignarNumerosAleatorios(){let e=new Set;this.cambiaSorteo||this.proyectos.forEach(t=>{let o=parseInt(t.numero_aleatorio);isNaN(o)||e.add(o)}),this.proyectos=this.proyectos.map(t=>{let o;if(!this.cambiaSorteo&&t.numero_aleatorio&&t.numero_aleatorio!=="")return I(w({},t),{numero:t.numero_aleatorio});do o=Math.floor(Math.random()*this.aprobados)+1;while(e.has(o));return e.add(o),I(w({},t),{numero:o.toString()})})}deshacerSorteo(){S.default.fire({title:"\xBFEst\xE1 seguro de deshacer este Sorteo?",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Aceptar",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&(S.default.fire({title:"Sorteo deshecho con \xE9xito"}),this.sorteoIniciado=!1,this.columnasVisibles=["position"],this.proyectos=this.proyectos.map(t=>I(w({},t),{numero:""})),this.cambiaSorteo=!1)})}cambiarOrden(){this.asignarNumerosAleatorios()}aceptarSorteo(){this.service.insertaSorteo(this.tokenSesion).subscribe({next:e=>{S.default.fire({title:"Sorteo aplicado con \xE9xito!",icon:"success",draggable:!0});let t=e.id;console.log(t),this.guardaProyectosConSorteo(t)},error:e=>{console.error("Error al crear sorteo",e),e.error.code===160&&this.servicea.cerrarSesionByToken(),S.default.fire("Error","No se pudo crear el sorteo.","error")}})}guardaProyectosConSorteo(e){this.proyectos.forEach(t=>{let o={folio:t.folio,numero_aleatorio:t.numero,sorteo:e};this.service.actualizaProyecto(this.tokenSesion,o).subscribe({next:a=>{console.log(a)},error:a=>{console.error("Error al guardar proyecto",o,a),a.error.code===160&&this.servicea.cerrarSesionByToken()}})}),S.default.fire("Exito","Sorteo y proyectos guardados correctamente.","success"),this.columnasVisibles=["position"],this.sorteoIniciado=!1}static \u0275fac=function(t){return new(t||i)(T(A),T(_t),T(B))};static \u0275cmp=q({type:i,selectors:[["app-sorteo"]],decls:16,vars:4,consts:[["appearance","outlined",1,"sorteo-card"],[1,"header-content"],[1,"label-header"],[1,"form-section"],[1,"form-label"],["appearance","outline",1,"full-width"],["disableRipple","",3,"selectionChange","valueChange","value"],[3,"value",4,"ngFor","ngForOf"],[1,"card-content"],[4,"ngIf"],["class","overlay",4,"ngIf"],[3,"value"],["cols","3","rowHeight","100px"],[3,"colspan","rowspan"],["appearance","outlined",1,"inventario-card"],[1,"inventario-content"],[1,"iconAprove"],[1,"iconSort"],[1,"iconSorte"],[1,"mat-elevation-z8"],["mat-table","",1,"custom-table",3,"dataSource"],["matColumnDef","position"],["mat-header-cell","","class","center-header",4,"matHeaderCellDef"],["mat-cell","","class","center-cell",4,"matCellDef"],["matColumnDef","numero",4,"ngIf"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["cols","2","rowHeight","100px"],[3,"colspan","rowspan",4,"ngIf"],["mat-fab","","extended","","color","warn",3,"click",4,"ngIf"],["mat-header-cell","",1,"center-header"],["mat-cell","",1,"center-cell"],["matColumnDef","numero"],["mat-header-row",""],["mat-row",""],["mat-fab","","extended","","color","primary",3,"click"],["mat-fab","","extended","","color","accent",3,"click"],["mat-fab","","extended","","color","warn",3,"click"],[1,"overlay"],["id","canvas","width","400","height","300"]],template:function(t,o){t&1&&(r(0,"mat-card",0)(1,"mat-card-header",1)(2,"mat-card-title",2),c(3,"Nuevo Sorteo"),n(),r(4,"div",3)(5,"label",4),c(6,"Seleccione una Unidad Territorial"),n(),r(7,"mat-form-field",5)(8,"mat-label"),c(9,"Seleccione unidad territorial"),n(),r(10,"mat-select",6),C("selectionChange",function(h){return o.onDistritoChange(h.value)}),Q("valueChange",function(h){return K(o.selectedUnidad,h)||(o.selectedUnidad=h),h}),u(11,Jt,2,2,"mat-option",7),n()()()(),r(12,"mat-card-content",8),u(13,ae,46,18,"div",9),n()(),u(14,se,2,0,"div",10),b(15,"app-footer")),t&2&&(s(10),J("value",o.selectedUnidad),s(),m("ngForOf",o.unidades),s(2),m("ngIf",o.mostrarDiv),s(),m("ngIf",o.animandoSorteo))},dependencies:[gt,pt,ut,ht,ft,Rt,ct,nt,rt,at,At,Mt,It,Dt,Pt,wt,Tt,Et,Ot,kt,Ht,Ct,bt,St,st,dt,mt,vt,xt,yt,Bt,Ft,Z,X,Y,it,ot,et,lt],styles:[".sorteo-card[_ngcontent-%COMP%]{max-width:800px;margin:32px auto;padding:16px}.header-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center}.label-header[_ngcontent-%COMP%]{font-size:18px;font-weight:600;padding-top:30px;padding-bottom:30px}.form-section[_ngcontent-%COMP%]{width:60%}.form-label[_ngcontent-%COMP%]{font-size:14px;margin-bottom:4px;display:block}.full-width[_ngcontent-%COMP%]{width:100%}.card-content[_ngcontent-%COMP%]{margin-top:24px;display:flex;flex-direction:column;gap:16px;align-items:center;padding-bottom:0!important}mat-form-field[_ngcontent-%COMP%]{margin-right:16px}.buttonSorteo[_ngcontent-%COMP%]{color:#fafafa!important;border-radius:none;background-color:#6745e0!important}.buttonSorteo[_ngcontent-%COMP%]:hover{background-color:#7072dd!important;color:#fafafa!important}.buttonOrden[_ngcontent-%COMP%]{color:#fafafa!important;background-color:#ad6f1e!important}.buttonOrden[_ngcontent-%COMP%]:hover{background-color:#be863b!important;color:#fafafa!important}.buttonSorteoD[_ngcontent-%COMP%]{color:#fafafa!important;background-color:#af2525!important}.buttonSorteoD[_ngcontent-%COMP%]:hover{background-color:#cc4c4c!important;color:#fafafa!important}.overlay[_ngcontent-%COMP%]{position:fixed;padding-left:8%;top:0;left:10px;width:100%;height:100%;background:#fffc;display:flex;justify-content:center;align-items:center;z-index:9999}.inventario-card[_ngcontent-%COMP%]{height:100%}.inventario-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-size:10px;font-weight:700;gap:8px}.iconAprove[_ngcontent-%COMP%]{color:#33c233;font-size:25px}.iconSort[_ngcontent-%COMP%]{color:#53caca;font-size:25px}.iconSorte[_ngcontent-%COMP%]{color:#ad53c9;font-size:25px}.custom-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .custom-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{text-align:center;vertical-align:middle}.center-header[_ngcontent-%COMP%]{font-weight:700;text-align:center}.center-cell[_ngcontent-%COMP%]{text-align:center}"]})};export{Vt as SorteoComponent};
